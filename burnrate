#!/usr/bin/env bash
# burnrate - Claude token cost tracker
# Zero tokens used - reads local stats only

set -euo pipefail

# ============================================================================
# Bootstrap
# ============================================================================

# Get script directory (resolve symlinks)
SCRIPT_SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SCRIPT_SOURCE" ]; do
    SCRIPT_DIR="$(cd -P "$(dirname "$SCRIPT_SOURCE")" && pwd)"
    SCRIPT_SOURCE="$(readlink "$SCRIPT_SOURCE")"
    [[ $SCRIPT_SOURCE != /* ]] && SCRIPT_SOURCE="$SCRIPT_DIR/$SCRIPT_SOURCE"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SCRIPT_SOURCE")" && pwd)"

# Locate lib directory â€” supports local/symlink install and Homebrew
# Local:  $SCRIPT_DIR/lib/               (default install via install.sh)
# Brew:   $SCRIPT_DIR/../share/burnrate/lib/  (brew puts binary in bin/, libs in share/)
if [[ -d "$SCRIPT_DIR/lib" ]]; then
    LIB_DIR="$SCRIPT_DIR/lib"
elif [[ -d "$SCRIPT_DIR/../share/burnrate/lib" ]]; then
    LIB_DIR="$(cd "$SCRIPT_DIR/../share/burnrate/lib" && pwd)"
else
    echo "Error: burnrate libraries not found. Try reinstalling: brew reinstall burnrate" >&2
    exit 1
fi

# Source libraries
source "$LIB_DIR/core.sh"
source "$LIB_DIR/config.sh"
source "$LIB_DIR/colors.sh"
source "$LIB_DIR/layout.sh"
source "$LIB_DIR/animations.sh"
source "$LIB_DIR/themes.sh"
source "$LIB_DIR/pricing.sh"
source "$LIB_DIR/stats.sh"
source "$LIB_DIR/budget.sh"
source "$LIB_DIR/historical.sh"
source "$LIB_DIR/charts.sh"
source "$LIB_DIR/export.sh"
source "$LIB_DIR/session.sh"

# ============================================================================
# Help & Usage
# ============================================================================

show_help() {
    cat <<'EOF'
burnrate - Track Claude Code token costs with zero API calls

USAGE:
    burnrate [COMMAND] [OPTIONS]

COMMANDS:
    (no command)     Show today's summary (default)
    show             Show detailed cost report
    history          Show daily usage history
    week             Show this week's aggregate
    month            Show this month's aggregate
    trends           Show spending trends
    budget           Check budget status and alerts
    export           Export data (json/csv/markdown)
    themes           List available themes
    preview <theme>  Preview a theme
    setup            Run interactive setup wizard
    config           Show current configuration
    context          Show context window usage + recommendation
    query <metric>   Single raw metric â€” for scripting/agents (no formatting)
    doctor           Full health check (28 assertions)
    version          Show version information
    help             Show this help message

EXPORT:
    burnrate export summary [format] [file]
    burnrate export history [format] [file] [start] [end]
    burnrate export budget [format] [file]
    burnrate export full [format] [file]

    Formats: json, csv, markdown (default: json)
    Example: burnrate export summary markdown report.md

OPTIONS:
    --theme <name>   Use specific theme
    --format <fmt>   Output format (detailed|compact|minimal|json)
    --no-color       Disable colors
    --no-emoji       Disable emoji
    --no-anim        Disable animations
    --debug          Enable debug logging
    --quiet          Minimal output

EXAMPLES:
    burnrate                    # Today's summary
    burnrate show               # Detailed report
    burnrate budget             # Budget status
    burnrate themes             # List themes
    burnrate preview ember      # Preview ember theme
    burnrate --theme ember      # Use ember theme
    burnrate --format json      # JSON output

CONFIGURATION:
    Config file: ~/.config/burnrate/burnrate.conf
    See: burnrate config

THEMES:
    Bundled themes: glacial, ember, battery, hourglass, garden, ocean, space
    User themes: ~/.config/burnrate/themes/
    Create: copy example from config/themes/ and customize

MORE INFO:
    GitHub: https://github.com/samridhgupta/burnrate
    Issues: https://github.com/samridhgupta/burnrate/issues

EOF
}

show_version() {
    echo "burnrate version $BURNRATE_VERSION"
    echo "Zero tokens used - reads local files only"
}

# ============================================================================
# Main Commands
# ============================================================================

# Show today's summary (default command)
cmd_summary() {
    show_banner

    # Disclaimer: only in non-TTY (piped/scripted) â€” banner covers it in terminals
    if [[ "$CONFIG_SHOW_DISCLAIMER" == "true" ]] && [[ ! -t 1 ]]; then
        echo "âš ï¸  ZERO TOKENS USED - Pure script, reads local files only"
        echo ""
    fi

    _themed_hr
    echo -e "  ðŸ“Š Token Burn Summary"
    _themed_hr
    echo ""

    show_summary "$CONFIG_STATS_FILE"

    # Context window auto-warn (if enabled and data available)
    if [[ "${CONFIG_CONTEXT_WARN:-true}" == "true" ]]; then
        local ctx
        if ctx=$(get_session_context 2>/dev/null); then
            local ctx_pct ctx_pct_int
            ctx_pct=$(echo "$ctx" | cut -d'|' -f3)
            ctx_pct_int=$(echo "$ctx_pct" | awk '{printf "%d", $1+0}')
            local threshold="${CONFIG_CONTEXT_WARN_THRESHOLD:-85}"
            if (( ctx_pct_int >= threshold )); then
                local used window
                used=$(echo "$ctx"   | cut -d'|' -f1)
                window=$(echo "$ctx" | cut -d'|' -f2)
                echo ""
                printf "  \033[0;33mâš ï¸  Context: %s%% full (%s / %s tokens)\033[0m\n" \
                    "$ctx_pct" "$used" "$window"
                echo -e "  \033[2mRun: burnrate context  |  Or: /compact in Claude\033[0m"
            fi
        fi
    fi

    echo ""
    if [[ "$CONFIG_SHOW_DISCLAIMER" == "true" ]]; then
        echo -e "\033[2m${THEME_FOOTER}\033[0m"
    fi
}

# Show detailed report
cmd_show() {
    show_banner

    # Disclaimer only in non-TTY â€” banner covers it in terminals
    if [[ "$CONFIG_SHOW_DISCLAIMER" == "true" ]] && [[ ! -t 1 ]]; then
        echo "âš ï¸  ZERO TOKENS USED - Pure script, reads local files only"
        echo ""
    fi

    local _trend _change
    _trend=$(get_spending_trend)
    _change=$(echo "$_trend" | cut -d'|' -f3)

    show_detailed_breakdown "$CONFIG_STATS_FILE" "$_change"

    _themed_hr

    if [[ "$CONFIG_SHOW_DISCLAIMER" == "true" ]]; then
        echo -e "\033[2m${THEME_FOOTER}\033[0m"
        echo ""
    fi
}

# Check budget status
cmd_budget() {
    if [[ "$CONFIG_SHOW_DISCLAIMER" == "true" ]] && [[ ! -t 1 ]]; then
        echo "âš ï¸  ZERO TOKENS USED - Pure script, reads local files only"
        echo ""
    fi

    show_budget_summary

    if [[ "$CONFIG_SHOW_DISCLAIMER" == "true" ]]; then
        echo ""
        echo "${THEME_FOOTER}"
    fi
}

# Show daily history
cmd_history() {
    local format="${1:-table}"

    if [[ "$CONFIG_SHOW_DISCLAIMER" == "true" ]] && [[ ! -t 1 ]]; then
        echo "âš ï¸  ZERO TOKENS USED - Pure script, reads local files only"
        echo ""
    fi

    echo "ðŸ“… Daily Token Usage History"
    echo ""

    format_daily_breakdown "$format"

    if [[ "$CONFIG_SHOW_DISCLAIMER" == "true" ]]; then
        echo ""
        echo "${THEME_FOOTER}"
    fi
}

# Show weekly aggregate
cmd_week() {
    if [[ "$CONFIG_SHOW_DISCLAIMER" == "true" ]] && [[ ! -t 1 ]]; then
        echo "âš ï¸  ZERO TOKENS USED - Pure script, reads local files only"
        echo ""
    fi

    echo "ðŸ“… This Week's Usage"
    echo ""

    local week_data
    week_data=$(get_week_aggregate)
    local tokens cost
    tokens=$(echo "$week_data" | cut -d'|' -f1)
    cost=$(echo "$week_data" | cut -d'|' -f2)

    printf "Tokens:  %15s\n" "$(printf "%'d" "$tokens" 2>/dev/null || echo "$tokens")"
    printf "Cost:    %15s\n" "\$$(format_cost "$cost")"

    if [[ "$CONFIG_SHOW_DISCLAIMER" == "true" ]]; then
        echo ""
        echo "${THEME_FOOTER}"
    fi
}

# Show monthly aggregate
cmd_month() {
    if [[ "$CONFIG_SHOW_DISCLAIMER" == "true" ]] && [[ ! -t 1 ]]; then
        echo "âš ï¸  ZERO TOKENS USED - Pure script, reads local files only"
        echo ""
    fi

    echo "ðŸ“… This Month's Usage"
    echo ""

    local month_data
    month_data=$(get_month_aggregate)
    local tokens cost
    tokens=$(echo "$month_data" | cut -d'|' -f1)
    cost=$(echo "$month_data" | cut -d'|' -f2)

    printf "Tokens:  %15s\n" "$(printf "%'d" "$tokens" 2>/dev/null || echo "$tokens")"
    printf "Cost:    %15s\n" "\$$(format_cost "$cost")"

    if [[ "$CONFIG_SHOW_DISCLAIMER" == "true" ]]; then
        echo ""
        echo "${THEME_FOOTER}"
    fi
}

# Show spending trends
cmd_trends() {
    if [[ "$CONFIG_SHOW_DISCLAIMER" == "true" ]] && [[ ! -t 1 ]]; then
        echo "âš ï¸  ZERO TOKENS USED - Pure script, reads local files only"
        echo ""
    fi

    show_historical_summary

    if [[ "$CONFIG_SHOW_DISCLAIMER" == "true" ]]; then
        echo ""
        echo "${THEME_FOOTER}"
    fi
}

# Export data
cmd_export() {
    local data_type="${1:-summary}"  # summary, history, budget, full
    local format="${2:-json}"         # json, csv, markdown
    local output_file="${3:-}"        # optional output file
    local start_date="${4:-}"         # for history
    local end_date="${5:-}"           # for history

    if [[ "$CONFIG_SHOW_DISCLAIMER" == "true" && -z "$output_file" ]]; then
        echo "âš ï¸  ZERO TOKENS USED - Pure script, reads local files only" >&2
        echo "" >&2
    fi

    export_data "$data_type" "$format" "$output_file" "$start_date" "$end_date"
}

# List themes
cmd_themes() {
    echo "ðŸŽ¨ Available Themes"
    echo ""
    list_themes detailed
}

# Preview theme
cmd_preview() {
    local theme_name="${1:-}"

    if [[ -z "$theme_name" ]]; then
        die_usage "Theme name required\nUsage: burnrate preview <theme>"
    fi

    preview_theme "$theme_name"
}

# Show configuration
cmd_config() {
    show_config
}

# Run setup wizard
cmd_setup() {
    source "$LIB_DIR/setup.sh"
    run_setup
}

cmd_doctor() {
    source "$LIB_DIR/doctor.sh"
    run_doctor "$@"
}

# ============================================================================
# Context Window Command
# ============================================================================

# _ctx_gauge <pct_int> â€” render a 30-char fill bar
_ctx_gauge() {
    local pct="$1"
    local width=30
    local filled=$(( pct * width / 100 ))
    (( filled > width )) && filled=$width

    local bar=""
    local i=0
    while (( i < filled )); do bar="${bar}â–ˆ"; (( i++ )); done
    while (( i < width ));  do bar="${bar}â–‘"; (( i++ )); done
    echo "$bar"
}

# _ctx_color <pct_int> â€” ANSI color for fill level
_ctx_color() {
    local pct="$1"
    if   (( pct >= 90 )); then printf '\033[0;31m'   # red
    elif (( pct >= 75 )); then printf '\033[0;33m'   # yellow
    elif (( pct >= 50 )); then printf '\033[0;36m'   # cyan
    else                       printf '\033[0;32m'   # green
    fi
}

# _ctx_rec <pct_int> â€” themed recommendation string
_ctx_rec() {
    local pct="$1"
    if   (( pct >= 90 )); then
        echo "${THEME_CTX_CRITICAL:-Context nearly full! Run /compact or start a new session. ðŸš¨}"
    elif (( pct >= 75 )); then
        echo "${THEME_CTX_WARNING:-Context getting full. Run /compact before the next heavy task. âš ï¸}"
    elif (( pct >= 50 )); then
        echo "${THEME_CTX_HALF:-Context half used. Consider /compact for long conversations. ðŸ’§}"
    else
        echo "${THEME_CTX_OK:-Context clear â€” plenty of room. â„ï¸}"
    fi
}

# Show context window usage gauge and recommendation
cmd_context() {
    local full_mode=false
    [[ "${1:-}" == "--full" ]] && full_mode=true

    local ctx_data
    if ! ctx_data=$(get_session_context 2>/dev/null); then
        echo "No session data found." >&2
        echo "Run a Claude Code session first, then check again." >&2
        exit 1
    fi

    local used window pct model inp cw cr out
    used=$(echo "$ctx_data"   | cut -d'|' -f1)
    window=$(echo "$ctx_data" | cut -d'|' -f2)
    pct=$(echo "$ctx_data"    | cut -d'|' -f3)
    model=$(echo "$ctx_data"  | cut -d'|' -f4)
    inp=$(echo "$ctx_data"    | cut -d'|' -f5)
    cw=$(echo "$ctx_data"     | cut -d'|' -f6)
    cr=$(echo "$ctx_data"     | cut -d'|' -f7)
    out=$(echo "$ctx_data"    | cut -d'|' -f8)

    local pct_int
    pct_int=$(echo "$pct" | awk '{printf "%d", $1+0}')

    local color reset='\033[0m'
    color=$(_ctx_color "$pct_int")

    local friendly_model
    friendly_model=$(get_friendly_model_name "$model")

    local gauge
    gauge=$(_ctx_gauge "$pct_int")

    local rec
    rec=$(_ctx_rec "$pct_int")

    # Format token numbers with commas (portable)
    _fmt_tok() { printf "%'d" "$1" 2>/dev/null || echo "$1"; }

    echo ""
    _themed_hr
    echo -e "  ðŸ§  Context Window"
    _themed_hr
    echo ""

    # Gauge line (CONFIG_CONTEXT_DISPLAY: visual | number | both)
    local display="${CONFIG_CONTEXT_DISPLAY:-both}"

    if [[ "$display" == "visual" || "$display" == "both" ]]; then
        printf "  %b[%s]%b  %s%%\n" "$color" "$gauge" "$reset" "$pct"
    fi

    if [[ "$display" == "number" || "$display" == "both" ]]; then
        printf "  %b%s%b / %s tokens used\n" \
            "$color" "$(_fmt_tok "$used")" "$reset" "$(_fmt_tok "$window")"
    fi

    echo ""
    echo -e "  ${rec}"

    if [[ "$full_mode" == "true" ]]; then
        echo ""
        echo -e "  \033[2mBreakdown (last turn)\033[0m"
        printf "  %-26s %s\n" "Input tokens:"          "$(_fmt_tok "$inp")"
        printf "  %-26s %s\n" "Cache created (write):" "$(_fmt_tok "$cw")"
        printf "  %-26s %s\n" "Cache hits (read):"     "$(_fmt_tok "$cr")"
        printf "  %-26s %s\n" "Output tokens:"         "$(_fmt_tok "$out")"
        echo ""
        printf "  %-26s %s\n" "Model:" "$friendly_model"
        printf "  %-26s %s\n" "Context window:"        "$(_fmt_tok "$window")"
    fi

    echo ""
    _themed_hr
}

# Query a single metric â€” raw output, no formatting, no color
# Designed for scripting, hooks, and agents
cmd_query() {
    local metric="${1:-}"

    if [[ -z "$metric" ]]; then
        cat >&2 <<'EOF'
Usage: burnrate query <metric>

Metrics:
  cost             Total cost (e.g. 4.21)
  tokens           Total token count (e.g. 2847392)
  cache_rate       Cache hit rate 0-100 (e.g. 87.30)
  cache_savings    Dollar savings from caching (e.g. 29.14)
  trend            Weekly % change, signed (e.g. -31.4 or N/A)
  weekly_cost      This week's spend (e.g. 2.11)
  monthly_cost     This month's spend (e.g. 14.67)
  last7_cost       Last 7 days spend (e.g. 3.28)
  model            Current model name (e.g. sonnet)
  context_tokens   Tokens used in current session context (e.g. 156312)
  context_pct      Context fill % 0-100 (e.g. 78.2)
  context_remaining Tokens remaining in context window (e.g. 43688)
EOF
        exit 1
    fi

    # Helper: ensure leading zero on bare decimals (.01 â†’ 0.01)
    _q_norm() { echo "$1" | awk '{printf "%g\n", $1+0}'; }

    local breakdown tokens model
    breakdown=$(get_usage_breakdown "$CONFIG_STATS_FILE" 2>/dev/null) || {
        echo "error: could not read stats" >&2; exit 1
    }

    case "$metric" in
        cost|total_cost)
            # Extract from the costs block (not the tokens block which also has "total")
            local v
            v=$(echo "$breakdown" | sed -n '/"costs":/,/^}/p' | grep '"total"' | grep -o '[0-9.]*')
            _q_norm "$v"
            ;;
        tokens|total_tokens)
            tokens=$(get_total_tokens "$CONFIG_STATS_FILE" 2>/dev/null)
            read -r inp out cw cr <<< "$tokens"
            echo $(( inp + out + cw + cr ))
            ;;
        cache_rate)
            get_cache_efficiency "$CONFIG_STATS_FILE" 2>/dev/null
            ;;
        cache_savings)
            model=$(echo "$breakdown" | grep '"model"' | tail -1 | cut -d'"' -f4)
            local sv
            sv=$(get_cache_savings "$CONFIG_STATS_FILE" "$model" 2>/dev/null)
            _q_norm "$sv"
            ;;
        trend)
            local t
            t=$(get_spending_trend 2>/dev/null)
            echo "$t" | cut -d'|' -f3
            ;;
        weekly_cost)
            local wv
            wv=$(get_week_aggregate 2>/dev/null | cut -d'|' -f2)
            _q_norm "$wv"
            ;;
        monthly_cost)
            local mv
            mv=$(get_month_aggregate 2>/dev/null | cut -d'|' -f2)
            _q_norm "$mv"
            ;;
        last7_cost)
            local lv
            lv=$(get_last_n_days_aggregate 7 2>/dev/null | cut -d'|' -f2)
            _q_norm "$lv"
            ;;
        model)
            echo "$breakdown" | grep '"model_friendly"' | cut -d'"' -f4
            ;;
        context_tokens)
            local ctx
            ctx=$(get_session_context 2>/dev/null) || { echo "N/A"; exit 0; }
            echo "$ctx" | cut -d'|' -f1
            ;;
        context_pct)
            local ctx
            ctx=$(get_session_context 2>/dev/null) || { echo "N/A"; exit 0; }
            echo "$ctx" | cut -d'|' -f3
            ;;
        context_remaining)
            local ctx
            ctx=$(get_session_context 2>/dev/null) || { echo "N/A"; exit 0; }
            local used window
            used=$(echo "$ctx"   | cut -d'|' -f1)
            window=$(echo "$ctx" | cut -d'|' -f2)
            echo $(( window - used ))
            ;;
        *)
            echo "error: unknown metric '$metric'" >&2
            echo "Run 'burnrate query' to see available metrics." >&2
            exit 1
            ;;
    esac
}

# ============================================================================
# Argument Parsing
# ============================================================================

# Parse command line arguments
parse_args() {
    local command=""
    local args=()

    while [[ $# -gt 0 ]]; do
        case "$1" in
            # Commands
            help|--help|-h)
                show_help
                exit 0
                ;;
            version|--version|-v)
                show_version
                exit 0
                ;;
            show|budget|history|week|month|trends|export|themes|preview|config|setup|doctor|query|context)
                command="$1"
                shift
                args=("$@")
                break
                ;;
            # Options
            --theme)
                CONFIG_THEME="$2"
                shift 2
                ;;
            --format)
                CONFIG_OUTPUT_FORMAT="$2"
                shift 2
                ;;
            --no-color|--no-colour)
                CONFIG_COLORS_ENABLED=false
                shift
                ;;
            --no-emoji)
                CONFIG_EMOJI_ENABLED=false
                shift
                ;;
            --no-anim|--no-animations)
                CONFIG_ANIMATIONS_ENABLED=false
                shift
                ;;
            --debug)
                CONFIG_DEBUG=true
                shift
                ;;
            --quiet|-q)
                CONFIG_QUIET=true
                shift
                ;;
            *)
                die_usage "Unknown option: $1\nRun 'burnrate help' for usage"
                ;;
        esac
    done

    # Execute command
    case "$command" in
        show)
            cmd_show "${args[@]+"${args[@]}"}"
            ;;
        budget)
            cmd_budget "${args[@]+"${args[@]}"}"
            ;;
        history)
            cmd_history "${args[@]+"${args[@]}"}"
            ;;
        week)
            cmd_week "${args[@]+"${args[@]}"}"
            ;;
        month)
            cmd_month "${args[@]+"${args[@]}"}"
            ;;
        trends)
            cmd_trends "${args[@]+"${args[@]}"}"
            ;;
        export)
            cmd_export "${args[@]+"${args[@]}"}"
            ;;
        themes)
            cmd_themes "${args[@]+"${args[@]}"}"
            ;;
        preview)
            cmd_preview "${args[@]+"${args[@]}"}"
            ;;
        config)
            cmd_config "${args[@]+"${args[@]}"}"
            ;;
        setup)
            cmd_setup "${args[@]+"${args[@]}"}"
            ;;
        doctor)
            cmd_doctor "${args[@]+"${args[@]}"}"
            ;;
        query)
            cmd_query "${args[@]+"${args[@]}"}"
            ;;
        context)
            cmd_context "${args[@]+"${args[@]}"}"
            ;;
        "")
            # Default: show summary
            cmd_summary
            ;;
        *)
            die_usage "Unknown command: $command\nRun 'burnrate help' for usage"
            ;;
    esac
}

# ============================================================================
# Main
# ============================================================================

main() {
    # Load configuration
    load_config

    # Validate configuration
    validate_config

    # Load theme
    load_theme "$CONFIG_THEME"

    # Parse arguments and run command
    parse_args "$@"
}

# Run main if not sourced
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
